import express from 'express';
import React from 'react';
import { renderToString } from 'react-dom/server';
import { StaticRouter } from 'react-router-dom';

import { createCss } from '#lib/theme/createCss';
import { App } from '#web/App';

const assets = require(process.env.RAZZLE_ASSETS_MANIFEST!);

const cssLinksFromAssets = (assets: any, entrypoint: any) => {
  return assets[entrypoint]
    ? assets[entrypoint].css
      ? assets[entrypoint].css
          .map((asset: string) => `<link rel="stylesheet" href="${asset}">`)
          .join('')
      : ''
    : '';
};

const jsScriptTagsFromAssets = (assets: any, entrypoint: any, extra = '') => {
  return assets[entrypoint]
    ? assets[entrypoint].js
      ? assets[entrypoint].js
          .map((asset: string) => `<script src="${asset}"${extra}></script>`)
          .join('')
      : ''
    : '';
};

export const renderApp = async (req: any, res: any) => {
  const markup = renderToString(
    <StaticRouter location={req.url}>
      <App />
    </StaticRouter>,
  );

  const html =
    // prettier-ignore
    `<!doctype html>
    <html lang="">
      <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta charSet='utf-8' />
        <title>Ganapathi - Carnatic Music Notation Software</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 105.83334 105.83333'>
          <style>
            svg {
              background: white;
              fill: none;
              stroke: rgb(108, 91, 123);
              stroke-width: 4px;
            }
            @media (prefers-color-scheme: dark)  {
              svg {
                background: rgb(87, 74, 100);
                stroke: white;
                stroke-width: 3px;
              }
            }
          </style>
          <g transform='translate(-79.523045,-77.832878)'>
            <g transform='translate(13.885777,4.1461787)'>
              <path d='m 91.588989,147.19043 c -6.239444,-8.95225 -2.441522,-4.61176 -3.255362,-11.66505 -0.81384,-7.05328 -7.324563,-10.30864 -7.324563,-10.30864 v 0 c 0,0 4.069201,-1.08512 5.425601,-1.89896 1.356402,-0.81385 3.797924,-2.98409 3.797924,-2.98409 0,0 3.526642,-1.89896 6.782004,-0.54256 3.255367,1.3564 4.611767,3.52665 5.696887,4.88305 1.08512,1.3564 -0.54256,5.96816 -0.81384,9.22352 -0.27128,3.25536 1.08512,7.32456 1.08512,8.68097 0,1.3564 -7.595847,4.34048 -7.595847,4.34048 z' />
              <path d='m 145.51882,147.19043 c 6.23948,-8.95225 2.44153,-4.61176 3.25538,-11.66505 0.81384,-7.05328 7.3246,-10.30864 7.3246,-10.30864 v 0 c 0,0 -4.06922,-1.08512 -5.42563,-1.89896 -1.35641,-0.81385 -3.79795,-2.98409 -3.79795,-2.98409 0,0 -3.52666,-1.89896 -6.78204,-0.54256 -3.25538,1.3564 -4.61179,3.52665 -5.69692,4.88305 -1.08512,1.3564 0.54257,5.96816 0.81385,9.22352 0.27128,3.25536 -1.08513,7.32456 -1.08513,8.68097 0,1.3564 7.59589,4.34048 7.59589,4.34048 z' />
              <path d='m 134.08835,125.46407 c -0.65964,-0.50623 -0.65964,-0.25311 -1.45121,-1.13901 -0.79156,-0.8859 -0.52771,-1.13901 -1.05542,-1.89835 -0.52771,-0.75934 -0.79156,-1.13901 -1.4512,-1.64524 -0.65965,-0.50622 -1.18735,-0.63278 -2.24278,-1.13901 -1.05542,-0.50622 -2.3747,-1.77179 -3.69398,-2.65769 -1.31927,-0.88589 -2.50662,-2.0249 -5.40903,-3.41703 h -0.47621 c -2.90239,1.39213 -4.08973,2.53114 -5.409,3.41703 -1.31927,0.8859 -2.63854,2.15147 -3.69396,2.65769 -1.05542,0.50623 -1.58312,0.63279 -2.24276,1.13901 -0.65964,0.50623 -0.92349,0.8859 -1.4512,1.64524 -0.52771,0.75934 -0.26385,1.01245 -1.05541,1.89835 -0.79157,0.8859 -0.79157,0.63278 -1.4512,1.13901' />
              <path d='m 133.91838,125.46407 c 0.23018,-3.56653 -0.0229,-3.9462 0.60985,-4.83209 0.63278,-0.8859 1.01246,-0.50623 2.15148,-2.91081 1.13901,-2.40458 1.13901,-4.6826 0.88589,-5.69505 -0.25311,-1.01245 -1.01246,-2.02491 -2.15147,-3.54358 -1.13902,-1.51869 -1.89836,-1.39213 -1.89836,-2.78425 0,-1.39213 -0.25312,-1.89835 -0.8859,-2.65769 -0.63279,-0.75934 -3.03738,-3.54359 -3.03738,-3.54359 0,0 -0.75934,-0.632783 -0.8859,-1.51868 -0.12656,-0.885896 -0.37967,-1.518682 -0.12656,-2.27802 0.25312,-0.759341 1.13901,-1.898351 1.26557,-2.531134 0.12656,-0.632785 0.12656,-1.771795 0,-2.404578 -0.12656,-0.632783 -0.50622,-1.392124 -1.7718,-2.657689 -1.26557,-1.265568 -1.7718,-1.518682 -2.27803,-2.27802 -0.50623,-0.759341 0,-1.518682 -0.37968,-1.771796 -0.37967,-0.253111 -2.27803,-0.885896 -3.03737,-1.392121 -0.75935,-0.506227 -2.15148,-2.404578 -1.89836,-2.784247 0.25311,-0.379672 1.13901,-0.759341 0.50623,-1.012455 -0.63279,-0.253114 -1.51869,-0.506227 -1.51869,-0.506227 h -2.01251 c 0,0 -0.8859,0.253113 -1.51868,0.506227 -0.63278,0.253114 0.25311,0.632783 0.50623,1.012455 0.25311,0.379669 -1.13901,2.27802 -1.89836,2.784247 -0.75934,0.506225 -2.65768,1.13901 -3.03736,1.392121 -0.37967,0.253114 0.12656,1.012455 -0.37967,1.771796 -0.50622,0.759338 -1.01245,1.012452 -2.27802,2.27802 -1.26556,1.265565 -1.64523,2.024906 -1.77179,2.657689 -0.12656,0.632783 -0.12656,1.771793 0,2.404578 0.12656,0.632783 1.01245,1.771793 1.26557,2.531134 0.25311,0.759338 0,1.392124 -0.12656,2.27802 -0.12656,0.885897 -0.8859,1.51868 -0.8859,1.51868 0,0 -2.40457,2.78425 -3.03736,3.54359 -0.63278,0.75934 -0.88589,1.26556 -0.88589,2.65769 0,1.39212 -0.75934,1.26556 -1.89835,2.78425 -1.13901,1.51867 -1.898354,2.53113 -2.151467,3.54358 -0.253114,1.01245 -0.253114,3.29047 0.885897,5.69505 1.13901,2.40458 1.51868,2.02491 2.15146,2.91081 0.63279,0.88589 0.37967,1.26556 0.60985,4.83209' />
              <path d='m 103.02793,142.77939 c 1.64523,1.39212 2.15146,2.02491 2.27802,2.91081 0.12655,0.88589 0.25311,3.7967 0.12655,4.30292 -0.12655,0.50623 -0.12655,1.39213 0.50623,1.89835 0.63279,0.50623 3.03736,1.7718 3.41703,2.40458 0.37967,0.63279 0.8859,1.51868 1.39213,3.41703' />
              <path d='m 134.20081,142.77939 c -1.64525,1.39212 -2.15148,2.02491 -2.27803,2.91081 -0.12656,0.88589 -0.25312,3.7967 -0.12656,4.30292 0.12656,0.50623 0.12656,1.39213 -0.50623,1.89835 -0.63279,0.50623 -3.03738,1.7718 -3.41705,2.40458' />
              <path d='m 105.30595,151.38525 c -2.53114,8.98552 -2.91081,9.87142 -2.91081,11.13699 0,1.26556 -0.54064,1.90126 -0.16097,2.28093 0.37967,0.37967 1.13901,0.37967 1.64523,0 0.50623,-0.37967 1.17343,-2.40749 2.05933,-3.92618 0.8859,-1.51867 1.51868,-3.29047 1.77179,-3.79669 0.25312,-0.50623 1.39213,-3.29048 1.39213,-3.29048' />
              <path d='m 110.74789,157.71308 c 1.1083,4.85417 1.8589,6.85578 2.1091,8.77399 0.2502,1.9182 0.1668,3.33601 0.2502,4.08661 0.0834,0.75061 0.6672,1.58461 1.50121,2.08501 0.834,0.5004 2.83561,1.1676 3.83641,1.58461 1.00081,0.417 2.83562,0.6672 4.17002,0.5838 1.33441,-0.0834 3.41942,-1.00081 3.91982,-1.33441 0.5004,-0.3336 1.668,-1.9182 1.668,-2.33521 0,-0.417 -0.1668,-3.25261 -0.1668,-4.67041 0,-1.41781 -0.0834,-3.08582 0.0834,-3.66962 0.1668,-0.5838 0.3336,-1.1676 0.6672,-1.5846 0.33361,-0.41701 0.91741,-0.75061 2.00161,-0.75061 1.08421,0 2.16841,0.3336 3.08582,0.5838 0.9174,0.2502 1.8348,0.33361 2.33521,0.83401 0.5004,0.5004 1.0842,0.417 1.0842,0.2502 0,-0.1668 0.3336,-1.08421 0.7506,-1.75141 0.417,-0.6672 1.00081,-1.8348 1.58461,-2.50201 0.5838,-0.6672 1.3344,-1.3344 1.3344,-1.83481 0,-0.5004 0.75061,-1.7514 -0.1668,-1.5012 -0.9174,0.2502 -1.9182,0.417 -2.58541,0.834 -0.6672,0.417 -1.5012,0.417 -2.50201,0.3336 -1.0008,-0.0834 -2.085,-0.3336 -3.08581,-0.5838 -1.0008,-0.2502 -2.99464,-0.86314 -4.74993,-0.84857 -1.7553,0.0146 -2.5059,0.26477 -3.2565,0.68177 -0.7506,0.417 -2.00161,1.41781 -2.50201,2.00161 -0.5004,0.5838 -1.41781,2.91901 -1.66801,3.66961 -0.2502,0.75061 -0.7506,2.41861 -1.251,4.08662' />
              <path d='m 131.95567,151.64181 c 1.3344,2.00161 2.00161,3.58621 2.00161,3.58621' />
              <path d='m 130.89439,128.08282 c -1.83482,-0.50041 -2.25183,-0.5838 -2.83563,0.2502 -0.58381,0.834 -0.75061,1.251 -0.83401,2.66881 -0.0834,1.4178 -0.1668,1.58461 0.3336,1.58461 0.50041,0 1.91822,0.0834 2.16842,-0.0834 0.25021,-0.16681 0.83401,-1.00081 0.91741,-1.83481 0.0834,-0.834 0.25021,-2.58541 0.25021,-2.58541 z' />
              <path d='m 106.03005,128.08282 c 1.83481,-0.50041 2.25181,-0.58381 2.83561,0.2502 0.5838,0.834 0.7506,1.251 0.834,2.66881 0.0834,1.4178 0.1668,1.5846 -0.3336,1.5846 -0.5004,0 -1.91821,0.0834 -2.16841,-0.0834 -0.2502,-0.1668 -0.834,-1.0008 -0.9174,-1.8348 -0.0834,-0.83401 -0.2502,-2.58541 -0.2502,-2.58541 z' />
              <path d='m 103.21972,106.53588 c 14.8277,-8.00854 30.60691,0.15859 30.60691,0.15859' />
            </g>
          </g>
        </svg>">
        ${ createCss() }
        ${ cssLinksFromAssets(assets, 'client') }
      </head>
      <body>
        <div id="root">${ markup }</div>
        ${ jsScriptTagsFromAssets(assets, 'client', ' defer crossorigin') }
      </body>
    </html>`;

  return { html };
};

const server = express();

server
  .disable('x-powered-by')
  .use(express.static(process.env.RAZZLE_PUBLIC_DIR!))
  .get('/*', async (req, res) => {
    const { html } = await renderApp(req, res);
    res.send(html);
  });

export default server;
